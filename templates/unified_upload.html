{% extends "base.html" %}
{% block title %}Unified Video Uploader{% endblock %}
{% block content %}
<!-- Main page content follows -->
        <!-- Unified Uploader Content -->
        <div class="row justify-content-center">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header bg-gradient-primary text-white">
                        <h2 class="text-center mb-0">
                            <i class="fas fa-video me-2"></i>Unified Video Uploader
                        </h2>
                        <p class="text-center mb-0 mt-2 opacity-75">
                            Upload videos to YouTube Shorts and Instagram Reels from a single interface
                        </p>
                    </div>
                    <div class="card-body">
                        <!-- Flash Messages -->
                        {% include 'unified_upload_flash.html' %}
                        <!-- Platform Selection -->
                        {% include 'unified_upload_platforms.html' %}
                        <!-- Client Selection (YouTube and Instagram) -->
                        {% include 'unified_upload_clients.html' %}
                        <!-- Channel/Account Selection -->
                        {% include 'unified_upload_channel.html' %}


                        <!-- Upload Form -->
                        <form method="POST" id="unifiedUploadForm">
                            <input type="hidden" id="selected_platform" name="platform" value="">
                            <input type="hidden" id="selected_client_id" name="client_id" value="">
                            <input type="hidden" id="selected_channel_id" name="channel_id" value="">
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <!-- Google Drive Link -->
                                    <div class="mb-3">
                                        <label for="drive_link" class="form-label">
                                            <i class="fas fa-link me-1"></i>Google Drive Link
                                            <span tabindex="0" data-bs-toggle="tooltip" title="Paste a valid Google Drive file link. Must start with https://drive.google.com/file/d/">
                                                <i class="fas fa-question-circle text-info"></i>
                                            </span>
                                        </label>
                                        <div id="dragDropArea" class="border border-2 rounded p-3 mb-2 text-center bg-light" style="cursor:pointer; min-height: 60px; transition: background 0.2s;">
                                            <span class="text-muted">Drag & drop a text file or link here, or paste below</span>
                                        </div>
                                        <div class="input-group">
                                            <input type="url" class="form-control" id="drive_link" name="drive_link" required
                                                   placeholder="https://drive.google.com/file/d/..." data-bs-toggle="tooltip" title="Paste a valid Google Drive file link">
                                            <button type="button" class="btn btn-outline-success" id="generateContentBtn" disabled>
                                                <i class="fas fa-magic me-1"></i>AI Generate
                                            </button>
                                            <span class="input-group-text" id="link-conversion-status" style="display: none;">
                                                <i class="fas fa-spinner fa-spin"></i>
                                            </span>
                                        </div>
                                        <div class="validation-error" id="drive_link_error"></div>
                                        <div class="validation-success" id="drive_link_success"></div>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            For Instagram uploads, view links are automatically converted to direct download links
                                        </small>
                                    </div>
                                    
                                    <!-- Filename Override (Optional) -->
                                    <div class="mb-3" id="filenameOverrideSection" style="display: none;">
                                        <label for="filename_override" class="form-label">
                                            <i class="fas fa-file me-1"></i>Filename (Optional)
                                            <span tabindex="0" data-bs-toggle="tooltip" title="If the filename is generic, you can enter the actual filename for better AI content generation.">
                                                <i class="fas fa-question-circle text-info"></i>
                                            </span>
                                        </label>
                                        <input type="text" class="form-control" id="filename_override" name="filename_override"
                                               placeholder="Enter the actual filename (e.g., 1212 Child Slavery.mp4)" data-bs-toggle="tooltip" title="Optional: Enter the actual filename if needed.">
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            If the system can't detect the filename automatically, you can enter it here for better AI content generation
                                        </div>
                                    </div>
                                    
                                    <!-- Title/Caption -->
                                    <div class="mb-3">
                                        <label for="title" class="form-label">
                                            <i class="fas fa-heading me-1"></i><span id="titleLabel">Title</span>
                                            <span tabindex="0" data-bs-toggle="tooltip" title="Enter a descriptive title or caption for your video.">
                                                <i class="fas fa-question-circle text-info"></i>
                                            </span>
                                        </label>
                                        <input type="text" class="form-control" id="title" name="title" required
                                               placeholder="Enter video title..." data-bs-toggle="tooltip" title="Required: Enter a descriptive title or caption.">
                                        <div class="validation-error" id="title_error"></div>
                                    </div>
                                    
                                    <!-- Description/Caption -->
                                    <div class="mb-3">
                                        <label for="description" class="form-label">
                                            <i class="fas fa-align-left me-1"></i><span id="descriptionLabel">Description</span>
                                            <span tabindex="0" data-bs-toggle="tooltip" title="Enter a detailed description or caption for your video.">
                                                <i class="fas fa-question-circle text-info"></i>
                                            </span>
                                        </label>
                                        <textarea class="form-control" id="description" name="description" rows="4" required
                                                  placeholder="Enter video description..." data-bs-toggle="tooltip" title="Required: Enter a detailed description or caption."></textarea>
                                        <div class="validation-error" id="description_error"></div>
                                    </div>
                                    
                                    <!-- Hashtags -->
                                    <div class="mb-3">
                                        <label for="hashtags" class="form-label">
                                            <i class="fas fa-hashtag me-1"></i>Hashtags
                                            <span tabindex="0" data-bs-toggle="tooltip" title="Enter hashtags separated by spaces (e.g., #shorts #viral #trending)">
                                                <i class="fas fa-question-circle text-info"></i>
                                            </span>
                                        </label>
                                        <input type="text" class="form-control" id="hashtags" name="hashtags"
                                               placeholder="Enter hashtags separated by spaces..." data-bs-toggle="tooltip" title="Separate hashtags with spaces (e.g., #shorts #viral #trending)">
                                        <div class="form-text">Separate hashtags with spaces (e.g., #shorts #viral #trending)</div>
                                        <div class="validation-error" id="hashtags_error"></div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <!-- Privacy Settings (YouTube only) -->
                                    <div id="privacySection" class="mb-3" style="display: none;">
                                        <label for="privacy" class="form-label">
                                            <i class="fas fa-eye me-1"></i>Privacy Setting
                                        </label>
                                        <select class="form-select" id="privacy" name="privacy">
                                            <option value="public">Public</option>
                                            <option value="unlisted">Unlisted</option>
                                            <option value="private">Private</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Upload Button -->
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn" disabled aria-busy="false">
                                            <i class="fas fa-upload me-2"></i>Upload Video
                                        </button>
                                    </div>
                                    <!-- Spinner overlay -->
                                    <div id="uploadSpinnerOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);z-index:2000;align-items:center;justify-content:center;">
                                        <div class="spinner-border text-primary" role="status" aria-live="polite" aria-label="Uploading...">
                                            <span class="visually-hidden">Uploading...</span>
                                        </div>
                                    </div>
                                    <!-- Upload Progress -->
                                    <div id="uploadProgress" class="mt-3" style="display: none; transition: opacity 0.3s;" aria-live="polite" aria-label="Upload progress">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" style="width: 100%"></div>
                                        </div>
                                        <small class="text-muted mt-2 d-block">Uploading video...</small>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let selectedPlatform = '';
            let selectedClientId = '';
            let selectedChannelId = '';

            // Platform selection
            document.querySelectorAll('.select-platform-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const platform = this.dataset.platform;
                    selectPlatform(platform);
                    updateGenerateButtonState(); // Update generate button state when platform changes
                });
            });

            function selectPlatform(platform) {
                selectedPlatform = platform;
                selectedClientId = '';
                selectedChannelId = '';
                
                // Update UI
                document.querySelectorAll('.platform-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`[data-platform="${platform}"]`).classList.add('selected');
                
                // Show/hide client sections
                document.querySelectorAll('.client-section').forEach(section => {
                    section.style.display = 'none';
                });
                
                if (platform === 'youtube') {
                    document.getElementById('youtubeClientSection').style.display = 'block';
                    document.getElementById('titleLabel').textContent = 'Title';
                    document.getElementById('descriptionLabel').textContent = 'Description';
                    document.getElementById('privacySection').style.display = 'block';
                } else if (platform === 'instagram') {
                    document.getElementById('instagramClientSection').style.display = 'block';
                    document.getElementById('titleLabel').textContent = 'Caption';
                    document.getElementById('descriptionLabel').textContent = 'Caption';
                    document.getElementById('privacySection').style.display = 'none';
                }
                
                // Hide channel selection
                document.getElementById('channelSelectionSection').style.display = 'none';
                document.getElementById('selected_platform').value = platform;
                updateUploadButton();
            }

            // Client selection
            document.querySelectorAll('.select-client-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const clientId = this.dataset.clientId;
                    const platform = this.dataset.platform;
                    selectClient(clientId, platform);
                });
            });

            function selectClient(clientId, platform) {
                selectedClientId = clientId;
                selectedPlatform = platform;
                selectedChannelId = '';
                
                // Update UI
                document.querySelectorAll('.client-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`[data-client-id="${clientId}"][data-platform="${platform}"]`).classList.add('selected');
                
                document.getElementById('selected_client_id').value = clientId;
                document.getElementById('selected_platform').value = platform;
                
                // Show channel selection with a highlight
                const channelSection = document.getElementById('channelSelectionSection');
                channelSection.style.display = 'block';
                channelSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Add a temporary highlight to draw attention
                channelSection.style.backgroundColor = '#fff3cd';
                channelSection.style.border = '2px solid #ffc107';
                channelSection.style.borderRadius = '8px';
                channelSection.style.padding = '15px';
                setTimeout(() => {
                    channelSection.style.backgroundColor = '';
                    channelSection.style.border = '';
                    channelSection.style.borderRadius = '';
                    channelSection.style.padding = '';
                }, 3000);
                
                // Load channels/accounts
                loadChannelsOrAccounts(clientId, platform);
                
                // Update labels based on platform
                if (platform === 'youtube') {
                    document.getElementById('titleLabel').textContent = 'Title';
                    document.getElementById('descriptionLabel').textContent = 'Description';
                    document.getElementById('privacySection').style.display = 'block';
                } else {
                    document.getElementById('titleLabel').textContent = 'Caption';
                    document.getElementById('descriptionLabel').textContent = 'Caption';
                    document.getElementById('privacySection').style.display = 'none';
                }
                
                updateUploadButton();
            }

            function loadChannelsOrAccounts(clientId, platform) {
                const channelSection = document.getElementById('channelSelectionSection');
                const channelSelection = document.getElementById('channelSelection');
                
                channelSelection.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Loading channels/accounts...</div>';
                channelSection.style.display = 'block';
                
                if (platform === 'youtube') {
                    // Load YouTube channels
                    fetch(`/api/channels/${clientId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.channels.length > 0) {
                                let html = '<div class="row">';
                                data.channels.forEach(channel => {
                                    html += `
                                        <div class="col-md-6 mb-3">
                                            <div class="card channel-card" data-channel-id="${channel.id}">
                                                <div class="card-body">
                                                    <h6 class="card-title">${channel.title}</h6>
                                                    <p class="card-text text-muted">${channel.description || 'No description'}</p>
                                                    <button class="btn btn-sm btn-outline-primary select-channel-btn" 
                                                            data-channel-id="${channel.id}">
                                                        <i class="fas fa-check me-1"></i>Select Channel
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                });
                                html += '</div>';
                                channelSelection.innerHTML = html;
                                
                                // Add event listeners to channel buttons
                                document.querySelectorAll('.select-channel-btn').forEach(btn => {
                                    btn.addEventListener('click', function() {
                                        const channelId = this.dataset.channelId;
                                        selectChannel(channelId);
                                    });
                                });
                            } else {
                                channelSelection.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No channels found for this client.</div>';
                            }
                        })
                        .catch(error => {
                            channelSelection.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading channels.</div>';
                        });
                } else if (platform === 'instagram') {
                    // Load Instagram accounts
                    fetch(`/api/instagram/accounts/${clientId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.accounts.length > 0) {
                                let html = '<div class="row">';
                                data.accounts.forEach(account => {
                                    html += `
                                        <div class="col-md-6 mb-3">
                                            <div class="card channel-card" data-channel-id="${account.id}">
                                                <div class="card-body">
                                                    <h6 class="card-title">${account.name}</h6>
                                                    <p class="card-text text-muted">${account.username || 'No username'}</p>
                                                    <button class="btn btn-sm btn-outline-warning select-channel-btn" 
                                                            data-channel-id="${account.id}">
                                                        <i class="fas fa-check me-1"></i>Select Account
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                });
                                html += '</div>';
                                channelSelection.innerHTML = html;
                                
                                // Add event listeners to account buttons
                                document.querySelectorAll('.select-channel-btn').forEach(btn => {
                                    btn.addEventListener('click', function() {
                                        const channelId = this.dataset.channelId;
                                        selectChannel(channelId);
                                    });
                                });
                            } else {
                                channelSelection.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No accounts found for this client.</div>';
                            }
                        })
                        .catch(error => {
                            channelSelection.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading accounts.</div>';
                        });
                }
            }

            function selectChannel(channelId) {
                selectedChannelId = channelId;
                
                // Update UI
                document.querySelectorAll('.channel-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`[data-channel-id="${channelId}"]`).classList.add('selected');
                
                // Update hidden input
                document.getElementById('selected_channel_id').value = channelId;
                
                // Show success message
                const channelSection = document.getElementById('channelSelectionSection');
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success alert-dismissible fade show';
                successDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>Channel selected successfully! Channel ID: ${channelId}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                channelSection.insertBefore(successDiv, channelSection.firstChild);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.remove();
                    }
                }, 5000);
                
                updateUploadButton();
            }

            function updateUploadButton() {
                const uploadBtn = document.getElementById('uploadBtn');
                const isComplete = selectedPlatform && selectedClientId && selectedChannelId;
                
                uploadBtn.disabled = !isComplete;
                
                if (isComplete) {
                    const platformText = selectedPlatform === 'youtube' ? 'YouTube' : 'Instagram';
                    uploadBtn.innerHTML = `<i class="fas fa-upload me-2"></i>Upload to ${platformText}`;
                } else {
                    uploadBtn.innerHTML = `<i class="fas fa-upload me-2"></i>Upload Video`;
                }
                

            }
            


            // Form submission
            document.getElementById('unifiedUploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get values from hidden inputs (these are what actually get sent to server)
                const platformValue = document.getElementById('selected_platform').value;
                const clientIdValue = document.getElementById('selected_client_id').value;
                const channelIdValue = document.getElementById('selected_channel_id').value;
                
                if (!platformValue) {
                    alert('Please select a platform (YouTube or Instagram) first.');
                    return;
                }
                
                if (!clientIdValue) {
                    alert('Please select a client first.');
                    return;
                }
                
                if (!channelIdValue) {
                    alert('Please select a channel/account. The channel selection should appear after you select a client.');
                    // Show the channel selection section if it's hidden
                    document.getElementById('channelSelectionSection').style.display = 'block';
                    return;
                }
                
                // For Instagram uploads, use the converted direct link if available
                if (selectedPlatform === 'instagram') {
                    const driveLinkInput = document.getElementById('drive_link');
                    const directLink = driveLinkInput.getAttribute('data-direct-link');
                    
                    if (directLink) {
                        // Create a hidden input for the direct link
                        let hiddenInput = document.getElementById('direct_drive_link');
                        if (!hiddenInput) {
                            hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.id = 'direct_drive_link';
                            hiddenInput.name = 'direct_drive_link';
                            this.appendChild(hiddenInput);
                        }
                        hiddenInput.value = directLink;
                    }
                }
                
                // Show progress
                document.getElementById('uploadProgress').style.display = 'block';
                document.getElementById('uploadBtn').disabled = true;
                
                try {
                    // Submit form
                    this.submit();
                } catch (error) {
                    console.error('Error submitting form:', error);
                    alert('Error submitting form: ' + error.message);
                }
            });

            // Enhance upload progress and spinner overlay
            const uploadForm = document.getElementById('unifiedUploadForm');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadSpinnerOverlay = document.getElementById('uploadSpinnerOverlay');
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    uploadBtn.disabled = true;
                    uploadBtn.setAttribute('aria-busy', 'true');
                    uploadProgress.style.display = 'block';
                    uploadProgress.style.opacity = '1';
                    uploadSpinnerOverlay.style.display = 'flex';
                });
            }
            // Hide spinner overlay and progress bar on page load (in case of back navigation)
            window.addEventListener('pageshow', function() {
                uploadBtn.disabled = false;
                uploadBtn.setAttribute('aria-busy', 'false');
                uploadProgress.style.display = 'none';
                uploadProgress.style.opacity = '0';
                uploadSpinnerOverlay.style.display = 'none';
            });

            // Drive link validation and conversion
            document.getElementById('drive_link').addEventListener('blur', function() {
                const link = this.value.trim();
                if (link) {
                    // First validate the link
                    fetch('/api/validate-link', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ drive_link: link })
                    })
                    .then(response => response.json())
                    .then(data => {
                        const errorDiv = document.getElementById('drive_link_error');
                        const successDiv = document.getElementById('drive_link_success');
                        
                        if (data.success) {
                            errorDiv.textContent = '';
                            
                            // If Instagram is selected, also convert to direct link
                            if (selectedPlatform === 'instagram') {
                                // Show conversion loading indicator
                                const conversionStatus = document.getElementById('link-conversion-status');
                                conversionStatus.style.display = 'inline-block';
                                
                                fetch('/api/convert-drive-link', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ drive_link: link })
                                })
                                .then(response => response.json())
                                .then(convertData => {
                                    // Hide conversion loading indicator
                                    conversionStatus.style.display = 'none';
                                    
                                    if (convertData.success) {
                                        successDiv.innerHTML = `
                                            ✓ Valid Google Drive link<br>
                                            <small class="text-info">
                                                <i class="fas fa-sync me-1"></i>Converted to direct link for Instagram
                                            </small>
                                        `;
                                        // Store the converted link for form submission
                                        document.getElementById('drive_link').setAttribute('data-direct-link', convertData.direct_link);
                                    } else {
                                        successDiv.textContent = '✓ Valid Google Drive link (conversion failed)';
                                    }
                                })
                                .catch(error => {
                                    // Hide conversion loading indicator
                                    conversionStatus.style.display = 'none';
                                    successDiv.textContent = '✓ Valid Google Drive link (conversion failed)';
                                });
                            } else {
                                successDiv.textContent = '✓ Valid Google Drive link';
                            }
                            
                            this.classList.remove('is-invalid');
                            this.classList.add('is-valid');
                        } else {
                            successDiv.textContent = '';
                            errorDiv.textContent = data.error;
                            this.classList.remove('is-valid');
                            this.classList.add('is-invalid');
                        }
                    });
                }
            });

            // Inline validation for main fields
            function validateDriveLink() {
                const input = document.getElementById('drive_link');
                const errorDiv = document.getElementById('drive_link_error');
                const value = input.value.trim();
                if (!value) {
                    errorDiv.textContent = 'Google Drive link is required.';
                    input.classList.add('is-invalid');
                    showToast('Google Drive link is required.', 'error');
                    return false;
                }
                if (!/^https:\/\/drive\.google\.com\/file\/d\//.test(value)) {
                    errorDiv.textContent = 'Please enter a valid Google Drive file link.';
                    input.classList.add('is-invalid');
                    showToast('Please enter a valid Google Drive file link.', 'error');
                    return false;
                }
                errorDiv.textContent = '';
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
                return true;
            }
            function validateTitle() {
                const input = document.getElementById('title');
                const errorDiv = document.getElementById('title_error');
                const value = input.value.trim();
                if (!value) {
                    errorDiv.textContent = 'Title/Caption is required.';
                    input.classList.add('is-invalid');
                    showToast('Title/Caption is required.', 'error');
                    return false;
                }
                errorDiv.textContent = '';
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
                return true;
            }
            function validateDescription() {
                const input = document.getElementById('description');
                const errorDiv = document.getElementById('description_error');
                const value = input.value.trim();
                if (!value) {
                    errorDiv.textContent = 'Description/Caption is required.';
                    input.classList.add('is-invalid');
                    showToast('Description/Caption is required.', 'error');
                    return false;
                }
                errorDiv.textContent = '';
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
                return true;
            }
            function validateHashtags() {
                const input = document.getElementById('hashtags');
                const errorDiv = document.getElementById('hashtags_error');
                const value = input.value.trim();
                if (value && !/^#?\w+( #\w+)*$/.test(value.replace(/\s+/g, ' '))) {
                    errorDiv.textContent = 'Hashtags must be separated by spaces (e.g., #shorts #viral #trending).';
                    input.classList.add('is-invalid');
                    showToast('Hashtags must be separated by spaces (e.g., #shorts #viral #trending).', 'error');
                    return false;
                }
                errorDiv.textContent = '';
                input.classList.remove('is-invalid');
                if (value) input.classList.add('is-valid');
                return true;
            }
            document.getElementById('drive_link').addEventListener('input', validateDriveLink);
            document.getElementById('title').addEventListener('input', validateTitle);
            document.getElementById('description').addEventListener('input', validateDescription);
            document.getElementById('hashtags').addEventListener('input', validateHashtags);
            // Enable Bootstrap tooltips for all fields
            document.getElementById('drive_link').addEventListener('input', updateGenerateButtonState);

            // Enable Bootstrap tooltips for all fields, after DOM and Bootstrap are loaded
            document.addEventListener('DOMContentLoaded', function() {
              var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
              tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl);
              });
            });

            // Gemini AI Content Generation
            document.getElementById('generateContentBtn').addEventListener('click', function() {
                const driveLink = document.getElementById('drive_link').value.trim();
                const platform = selectedPlatform;
                const filenameOverride = document.getElementById('filename_override').value.trim();
                
                if (!driveLink) {
                    alert('Please enter a Google Drive link first');
                    return;
                }
                
                if (!platform) {
                    alert('Please select a platform first');
                    return;
                }
                
                // Show loading state
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
                this.disabled = true;
                
                // Call Gemini API
                fetch('/api/generate-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        drive_link: driveLink,
                        platform: platform,
                        filename_override: filenameOverride
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Restore button state
                    this.innerHTML = originalText;
                    this.disabled = false;
                    
                                            if (data.success) {
                            // Fill in the form fields with generated content
                            document.getElementById('title').value = data.content.title || '';
                            document.getElementById('description').value = data.content.description || '';
                            document.getElementById('hashtags').value = data.content.hashtags || '';
                            
                            // Show success message
                            const successDiv = document.getElementById('drive_link_success');
                            const isFallback = data.fallback || false;
                            const messageClass = isFallback ? 'text-warning' : 'text-success';
                            const messageIcon = isFallback ? 'fa-exclamation-triangle' : 'fa-magic';
                            const messageText = isFallback ? 'Fallback content generated' : 'AI content generated';
                            
                            // Check if filename is generic and show override option
                            const filename = data.filename || '';
                            const isGenericFilename = filename.startsWith('video_') || filename.startsWith('file_');
                            
                            if (isGenericFilename) {
                                document.getElementById('filenameOverrideSection').style.display = 'block';
                                successDiv.innerHTML = `
                                    ✓ Valid Google Drive link<br>
                                    <small class="${messageClass}">
                                        <i class="fas ${messageIcon} me-1"></i>${messageText} for "${data.filename}"
                                        ${isFallback ? '<br><small class="text-muted">(Gemini API rate limited - using basic template)</small>' : ''}
                                        <br><small class="text-info"><i class="fas fa-info-circle me-1"></i>Generic filename detected - you can enter the actual filename above for better content</small>
                                    </small>
                                `;
                            } else {
                                document.getElementById('filenameOverrideSection').style.display = 'none';
                                successDiv.innerHTML = `
                                    ✓ Valid Google Drive link<br>
                                    <small class="${messageClass}">
                                        <i class="fas ${messageIcon} me-1"></i>${messageText} for "${data.filename}"
                                        ${isFallback ? '<br><small class="text-muted">(Gemini API rate limited - using basic template)</small>' : ''}
                                    </small>
                                `;
                            }
                        
                        // Trigger validation for the filled fields
                        document.getElementById('title').dispatchEvent(new Event('input'));
                        document.getElementById('description').dispatchEvent(new Event('input'));
                        document.getElementById('hashtags').dispatchEvent(new Event('input'));
                        
                    } else {
                        alert(`Error generating content: ${data.error}`);
                    }
                })
                .catch(error => {
                    // Restore button state
                    this.innerHTML = originalText;
                    this.disabled = false;
                    alert(`Error: ${error.message}`);
                });
            });

            // Enable/disable generate content button based on drive link and platform selection
            function updateGenerateButtonState() {
                const driveLink = document.getElementById('drive_link').value.trim();
                const generateBtn = document.getElementById('generateContentBtn');
                
                if (driveLink && selectedPlatform) {
                    generateBtn.disabled = false;
                } else {
                    generateBtn.disabled = true;
                }
            }

            // Add event listeners for button state updates
            document.getElementById('drive_link').addEventListener('input', updateGenerateButtonState);

            // Drag-and-drop for Google Drive link
            const dragDropArea = document.getElementById('dragDropArea');
            const driveLinkInput = document.getElementById('drive_link');
            dragDropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                dragDropArea.classList.add('bg-primary', 'text-white');
            });
            dragDropArea.addEventListener('dragleave', function(e) {
                dragDropArea.classList.remove('bg-primary', 'text-white');
            });
            dragDropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                dragDropArea.classList.remove('bg-primary', 'text-white');
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.type.startsWith('text/')) {
                        const reader = new FileReader();
                        reader.onload = function(evt) {
                            driveLinkInput.value = evt.target.result.trim();
                            driveLinkInput.dispatchEvent(new Event('input'));
                        };
                        reader.readAsText(file);
                    }
                } else if (e.dataTransfer.getData('text')) {
                    driveLinkInput.value = e.dataTransfer.getData('text').trim();
                    driveLinkInput.dispatchEvent(new Event('input'));
                }
            });
            dragDropArea.addEventListener('click', function() {
                driveLinkInput.focus();
            });

            // Show toast on successful submission
            const unifiedUploadForm = document.getElementById('unifiedUploadForm');
            if (unifiedUploadForm) {
                unifiedUploadForm.addEventListener('submit', function(e) {
                    setTimeout(function() {
                        showToast('Upload submitted successfully!', 'success');
                    }, 500); // Show after progress bar appears
                });
            }
        </script>

        <style>
            .platform-card, .client-card, .channel-card {
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .platform-card:hover, .client-card:hover, .channel-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            }
            
            .platform-card.selected, .client-card.selected, .channel-card.selected {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.3);
            }
            
            .platform-card[data-platform="youtube"].selected {
                border-color: #dc3545;
                box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.3);
            }
            
            .platform-card[data-platform="instagram"].selected {
                border-color: #ffc107;
                box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.3);
            }
            
            .client-card[data-platform="youtube"].selected {
                border-color: #dc3545;
                box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.3);
            }
            
            .client-card[data-platform="instagram"].selected {
                border-color: #ffc107;
                box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.3);
            }
            
            .channel-card.selected {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.3);
            }
        </style>
{% endblock %} 